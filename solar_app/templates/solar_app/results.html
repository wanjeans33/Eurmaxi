{% extends 'solar_app/base.html' %}
{% load i18n %}

{% block content %}
<!-- è¿”å›æŒ‰é’® -->
<div class="row mb-3">
    <div class="col-12">
        <a href="{% url 'solar_app:index' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>{% trans "è¿”å›å‚æ•°è®¾ç½®" %}
        </a>
    </div>
</div>

<!-- ç»æµæ•ˆç›Šæ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-12">
        <h2 class="text-center mb-4">ğŸ’° {% trans "ç»æµæ•ˆç›Šè¯„ä¼°" %}</h2>
    </div>
    <div class="col-lg-4">
        <div class="card text-center h-100 border-info">
            <div class="card-body">
                <h5 class="card-title text-info">
                    <i class="fas fa-plug me-2"></i>{% trans "åŸºå‡†å¹´åº¦ç”µè´¹" %}
                </h5>
                <h3 class="text-primary">â‚¬ {{ results.baseline_cost|floatformat:0 }}</h3>
                <p class="text-muted">ä¸å®‰è£…å¤ªé˜³èƒ½ç³»ç»Ÿçš„å¹´åº¦ç”µè´¹</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card text-center h-100 border-warning">
            <div class="card-body">
                <h5 class="card-title text-warning">
                    <i class="fas fa-solar-panel me-2"></i>{% trans "æ— å‚¨èƒ½æ–¹æ¡ˆ" %}
                </h5>
                <h3 class="text-success">â‚¬ {{ results.cost_no_batt|floatformat:0 }}</h3>
                <div class="badge bg-success fs-6">
                    {% trans "èŠ‚çœ" %} â‚¬ {{ results.savings_no_batt|floatformat:0 }}
                </div>
                <p class="text-muted mt-2">ä»…å®‰è£…å¤ªé˜³èƒ½é¢æ¿</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card text-center h-100 border-success">
            <div class="card-body">
                <h5 class="card-title text-success">
                    <i class="fas fa-battery-three-quarters me-2"></i>{% trans "æœ‰å‚¨èƒ½æ–¹æ¡ˆ" %}
                </h5>
                <h3 class="text-success">â‚¬ {{ results.cost_with_batt|floatformat:0 }}</h3>
                <div class="badge bg-success fs-6">
                    {% trans "èŠ‚çœ" %} â‚¬ {{ results.savings_with_batt|floatformat:0 }}
                </div>
                <p class="text-muted mt-2">å¤ªé˜³èƒ½é¢æ¿ + ç”µæ± å‚¨èƒ½</p>
            </div>
        </div>
    </div>
</div>

<!-- å¹´åº¦èŠ‚çœå¯¹æ¯” -->
{% if params.battery_capacity_kwh > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5 class="alert-heading">
                <i class="fas fa-chart-line me-2"></i>{% trans "å‚¨èƒ½æ”¶ç›Šåˆ†æ" %}
            </h5>
            <p class="mb-2">
                <strong>{% trans "é¢å¤–æŠ•èµ„" %}ï¼š</strong>{% trans "ç”µæ± æˆæœ¬" %} â‚¬ {{ params.battery_cost|floatformat:0 }}
            </p>
            <p class="mb-2">
                <strong>{% trans "é¢å¤–å¹´åº¦èŠ‚çœ" %}ï¼š</strong>â‚¬ {{ extra_savings|floatformat:0 }}
            </p>
            {% if payback_years %}
            <p class="mb-0">
                <strong>{% trans "ç”µæ± æŠ•èµ„å›æ”¶æœŸ" %}ï¼š</strong>{% trans "çº¦" %} {{ payback_years|floatformat:1 }} {% trans "å¹´" %}
            </p>
            {% else %}
            <p class="mb-0">
                <strong>{% trans "ç”µæ± æŠ•èµ„å›æ”¶æœŸ" %}ï¼š</strong>{% trans "æ— æ³•å›æ”¶ï¼ˆå‚¨èƒ½æ–¹æ¡ˆæ”¶ç›Šä¸è¶³ï¼‰" %}
            </p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- å›¾è¡¨åŒºåŸŸ -->
<div class="row mb-4">
    <div class="col-12">
        <h3 class="text-center mb-4">ğŸ“Š {% trans "æœˆåº¦å‘ç”µä¸ç”¨ç”µåˆ†æ" %}</h3>
    </div>
    
    <!-- å‘ç”µé‡ä¸ç”¨ç”µé‡å¯¹æ¯” -->
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>{% trans "æœˆåº¦å‘ç”µé‡ä¸ç”¨ç”µé‡å¯¹æ¯”" %}
                </h5>
            </div>
            <div class="card-body">
                <canvas id="generationConsumptionChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- æ— å‚¨èƒ½æ–¹æ¡ˆ -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-solar-panel me-2"></i>{% trans "å…‰ä¼åˆ©ç”¨æƒ…å†µ - æ— å‚¨èƒ½æ–¹æ¡ˆ" %}
                </h5>
            </div>
            <div class="card-body">
                <canvas id="noBatteryChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- æœ‰å‚¨èƒ½æ–¹æ¡ˆ -->
    {% if params.battery_capacity_kwh > 0 %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-battery-three-quarters me-2"></i>{% trans "å…‰ä¼åˆ©ç”¨æƒ…å†µ - æœ‰å‚¨èƒ½æ–¹æ¡ˆ" %}
                </h5>
            </div>
            <div class="card-body">
                <canvas id="withBatteryChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>{% trans "è¯¦ç»†æœˆåº¦æ•°æ®" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>æœˆä»½</th>
                                <th>å‘ç”µé‡ (kWh)</th>
                                <th>ç”¨ç”µé‡ (kWh)</th>
                                <th colspan="3" class="text-center bg-warning">æ— å‚¨èƒ½æ–¹æ¡ˆ</th>
                                {% if params.battery_capacity_kwh > 0 %}
                                <th colspan="3" class="text-center bg-success">æœ‰å‚¨èƒ½æ–¹æ¡ˆ</th>
                                {% endif %}
                            </tr>
                            <tr>
                                <th></th>
                                <th></th>
                                <th></th>
                                <th class="bg-warning">è‡ªç”¨ (kWh)</th>
                                <th class="bg-warning">ä¸Šç½‘ (kWh)</th>
                                <th class="bg-warning">è´­ç”µ (kWh)</th>
                                {% if params.battery_capacity_kwh > 0 %}
                                <th class="bg-success">è‡ªç”¨ (kWh)</th>
                                <th class="bg-success">ä¸Šç½‘ (kWh)</th>
                                <th class="bg-success">è´­ç”µ (kWh)</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for month_data in results.monthly_data %}
                            <tr>
                                <td><strong>{{ month_data.æœˆä»½ }}</strong></td>
                                <td>{{ month_data.å‘ç”µé‡|floatformat:1 }}</td>
                                <td>{{ month_data.ç”¨ç”µé‡|floatformat:1 }}</td>
                                <td>{{ month_data.è‡ªç”¨ç”µé‡_æ— å‚¨èƒ½|floatformat:1 }}</td>
                                <td>{{ month_data.ä¸Šç½‘ç”µé‡_æ— å‚¨èƒ½|floatformat:1 }}</td>
                                <td>{{ month_data.è´­ç”µé‡_æ— å‚¨èƒ½|floatformat:1 }}</td>
                                {% if params.battery_capacity_kwh > 0 %}
                                <td>{{ month_data.è‡ªç”¨ç”µé‡_æœ‰å‚¨èƒ½|floatformat:1 }}</td>
                                <td>{{ month_data.ä¸Šç½‘ç”µé‡_æœ‰å‚¨èƒ½|floatformat:1 }}</td>
                                <td>{{ month_data.è´­ç”µé‡_æœ‰å‚¨èƒ½|floatformat:1 }}</td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// å›¾è¡¨æ•°æ®
const chartData = {
    noBattery: {{ chart_data.no_battery|safe }},
    withBattery: {{ chart_data.with_battery|safe }},
    generationConsumption: {{ chart_data.generation_consumption|safe }}
};

// å‘ç”µé‡ä¸ç”¨ç”µé‡å¯¹æ¯”å›¾
const ctxGenCons = document.getElementById('generationConsumptionChart').getContext('2d');
const generationConsumptionChart = new Chart(ctxGenCons, {
    type: 'line',
    data: chartData.generationConsumption,
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'ç”µé‡ (kWh)'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'æœˆåº¦å‘ç”µé‡ä¸ç”¨ç”µé‡å¯¹æ¯”'
            }
        }
    }
});

// æ— å‚¨èƒ½æ–¹æ¡ˆå›¾è¡¨
const ctxNoBattery = document.getElementById('noBatteryChart').getContext('2d');
const noBatteryChart = new Chart(ctxNoBattery, {
    type: 'bar',
    data: chartData.noBattery,
    options: {
        responsive: true,
        scales: {
            x: {
                stacked: true,
            },
            y: {
                stacked: true,
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'ç”µé‡ (kWh)'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
            }
        }
    }
});

// æœ‰å‚¨èƒ½æ–¹æ¡ˆå›¾è¡¨
{% if params.battery_capacity_kwh > 0 %}
const ctxWithBattery = document.getElementById('withBatteryChart').getContext('2d');
const withBatteryChart = new Chart(ctxWithBattery, {
    type: 'bar',
    data: chartData.withBattery,
    options: {
        responsive: true,
        scales: {
            x: {
                stacked: true,
            },
            y: {
                stacked: true,
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'ç”µé‡ (kWh)'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
